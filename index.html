<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Random Role Selector</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.css">
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <style>
        .app {
            padding: 50px !important;
        }

        .crossed {
            text-decoration: line-through;
        }

        .button-small {
            font-size: .8rem;
            height: 2.3rem;
            line-height: 2.3rem;
            padding: 0 1.5rem;
            float: left;
            margin-top: 1px;
            margin-right: 10px;
        }

        .button-red {
            border-color: red !important;
            color: red !important;
        }

        .statistics span {
            margin-right: 10px;
            width: 150px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div id="app" class="app">
        <h1>Mafia Random Role Selector</h1>
        <hr>
        <div class="statistics">
            <span>Total = <b>{{roles.length || 0}}</b></span>
            <span>Remaining =
                <b>{{roles.length - players.length}}</b></span>
            <br>
            <span v-for="role in roles_count">
                {{role.name}} = <b>{{role.count}}</b>
            </span>
        </div>
        <hr>
        <label for="role">Roles</label>
        <select id="role" v-model="new_role">
            <option disabled value="">Please select one</option>
            <option v-for="(role, index) in default_roles">{{role}}</option>
        </select>
        <button @click="addRole()">Add new role</button>
        <ol>
            <li v-for="(role, index) in roles">
                <button class="button button-outline button-small button-red" @click="removeRole(index)">x</button>
                <span :class="!isEmptyObj(role.player) ? 'crossed' : ''">
                    {{role.name}}
                </span>
            </li>
        </ol>
        <hr>
        <label for="player">Players</label>
        <input id="player" placeholder="Type player's name and hit Enter" type="text" v-model="new_player"
            @keyup.enter="addPlayer()">
        <button @click="addPlayer()">Add new player</button>
        <ol>
            <li v-for="(player, index) in players">
                <button class="button button-outline button-small button-red" @click="removePlayer(index)">x</button>
                {{player.name}}
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                {{player.role.name}}
            </li>
        </ol>

    </div>
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                new_player: '',
                new_role: '',
                players: [],
                roles: [],
                default_roles: ['Godfather', 'Mafia', 'Doctor', 'Detective', 'Armoured', 'Sniper', 'Citizen']
            },
            created: function () {
                this.load();
            },
            watch: {
                players: function () {
                    this.save();
                },
                roles: function () {
                    this.save();
                }
            },
            computed: {
                roles_count: function () {
                    const list = []
                    this.default_roles.map(x => list.push({ name: x, count: 0 }));
                    this.roles.map(x => {
                        list.map(y => {
                            if (x.name == y.name) {
                                y.count += 1;
                            };
                        });
                    })
                    return list;
                }
            },
            methods: {
                addPlayer: function () {
                    if (this.new_player.length > 0) {
                        if (this.roles.length > 0) {
                            const new_roles = this.roles.filter(x => this.isEmptyObj(x.player));
                            if (new_roles.length > 0) {
                                const rndIndex = this.rndBetween(0, new_roles.length - 1);
                                // const roleIndex = this.roles.findIndex(x => x.player == -1 && x.name == new_roles[rndIndex].name);
                                const player = { name: this.new_player, role: new_roles[rndIndex] };
                                this.players.push(player);
                                new_roles[rndIndex].player = this.players[this.players.length - 1];
                                this.new_player = '';
                            } else {
                                alert("All roles has been assigned to players.");
                            }
                        } else {
                            alert("Roles are empty.");
                        }
                    } else {
                        alert("Player's name is empty.");
                    }
                },
                addRole: function () {
                    if (this.new_role.length > 0) {
                        const new_role = { name: this.new_role, player: {} };
                        this.roles.push(new_role);
                    } else {
                        alert("Please select a role.");
                    }
                },
                removeRole: function (index) {
                    const player = this.roles[index].player;
                    if (!this.isEmptyObj(player)) {
                        playerIndex = this.players.findIndex(x => x === player);
                        this.players.splice(playerIndex, 1);
                    }
                    this.roles.splice(index, 1);
                },
                removePlayer: function (index) {
                    this.roles.map(x => {
                        if (x.player === this.players[index]) {
                            x.player = {};
                        };
                    });
                    this.players.splice(index, 1);
                },
                rndBetween: function (min, max) {
                    return Math.floor(Math.random() * max) + min;
                },
                load: function () {
                    const json_roles = JSON.parse(localStorage.getItem('roles')) || [];
                    const json_players = JSON.parse(localStorage.getItem('players')) || [];
                    json_roles.map(x => x.player = json_players[x.player] || {});
                    json_players.map(x => x.role = json_roles[x.role] || {});

                    this.roles = json_roles;
                    this.players = json_players;
                },
                save: function () {
                    const json_roles = [];
                    const json_players = [];
                    this.roles.map(x => {
                        json_roles.push({
                            name: x.name,
                            player: this.players.findIndex(y => y == x.player)
                        })
                    })
                    this.players.map(x => {
                        json_players.push({
                            name: x.name,
                            role: this.roles.findIndex(y => y == x.role)
                        })
                    })
                    localStorage.setItem('roles', JSON.stringify(json_roles));
                    localStorage.setItem('players', JSON.stringify(json_players));
                },
                isEmptyObj: function (obj) {
                    return Object.entries(obj).length === 0
                }
            },
        })
    </script>
</body>

</html>